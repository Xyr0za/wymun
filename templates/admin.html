<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal (Chairman)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        /* Define Dark Theme Colors */
        :root {
            --mun-primary: #D32F2F;        /* Admin Red Accent */
            --mun-dark-bg: #121212;        /* Very dark background */
            --mun-card: #1F2937;           /* Dark Card (Slate-900 equivalent) */
            --mun-light-text: #F3F4F6;     /* Near white text */
            --mun-secondary-text: #A0AEC0; /* Light gray for subtle text */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--mun-dark-bg);
            color: var(--mun-light-text);
        }
        .header {
            background-color: var(--mun-card);
            border-bottom: 2px solid #374151; /* Dark border */
        }
        textarea { resize: none; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="header shadow-lg p-4 flex justify-between items-center sticky top-0 z-10">
        <h1 class="text-2xl font-bold text-mun-primary">Admin Portal ({{ delegate_id }})</h1>
        <div class="flex items-center space-x-4">
            <a href="{{ url_for('dashboard') }}" target="_blank"
               class="text-sm font-medium text-mun-secondary-text hover:text-mun-primary transition">View Dashboard</a>
            <a href="{{ url_for('logout') }}"
               class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-semibold">Logout</a>
        </div>
    </header>

    <main class="flex flex-grow p-6 space-x-6">

        <section class="w-1/3 space-y-6">

            <div id="flash-container">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        <ul class="space-y-2">
                            {% for category, message in messages %}
                                <li class="p-3 rounded-lg font-medium border-l-4
                                    {% if category == 'error' %} bg-red-800 text-white border-red-500
                                    {% elif category == 'info' %} bg-blue-800 text-white border-blue-500
                                    {% else %} bg-green-800 text-white border-green-500
                                    {% endif %}" id="flash-{{ loop.index }}">
                                    {{ message }}
                                </li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                {% endwith %}
            </div>

            <div class="bg-mun-card p-6 rounded-xl shadow-xl border-t-4 border-mun-primary space-y-4">
                <h2 class="text-xl font-bold text-mun-primary">Chairman Actions</h2>
                <button onclick="clearStream()"
                    class="w-full bg-gray-600 hover:bg-gray-500 text-white font-semibold py-3 rounded-lg transition duration-150">
                    Clear Document Stream
                </button>
            </div>

            <div class="bg-mun-card p-6 rounded-xl shadow-xl border-t-4 border-mun-primary">
                <h2 class="text-xl font-bold text-mun-primary mb-4">Post Announcement</h2>
                <textarea id="announcement-content" rows="3"
                    class="w-full p-2 border-2 border-gray-600 bg-gray-700 text-mun-light-text rounded-lg focus:border-mun-primary focus:ring-mun-primary"
                    placeholder="Type official announcement here..."></textarea>
                <button onclick="postAnnouncement()"
                    class="mt-3 w-full bg-mun-primary hover:bg-[#A82323] text-white font-semibold py-3 rounded-lg transition duration-150 transform active:scale-95">
                    Post to Stream
                </button>
            </div>

            <div class="bg-mun-card p-6 rounded-xl shadow-xl border-t-4 border-indigo-500">
                <h2 class="text-xl font-bold text-indigo-400 mb-4">Formal Vote Control</h2>

                {% if current_vote_target %}
                    <div id="vote-active-status" class="p-4 bg-yellow-800/50 border-l-4 border-yellow-500 mb-4">
                        <p class="font-bold text-yellow-300">VOTE IN PROGRESS:</p>
                        <p class="text-sm text-yellow-200">{{ current_vote_target.title }}</p>
                    </div>
                {% else %}
                    <div id="vote-active-status" class="p-4 bg-green-800/50 border-l-4 border-green-500 mb-4">
                        <p class="font-bold text-green-300">NO VOTE ACTIVE</p>
                    </div>
                {% endif %}

                <div id="vote-selection-controls" class="space-y-4">
                    <label for="vote_target_id" class="block text-sm font-medium text-mun-light-text mb-2">Select Document to Vote On:</label>
                    <select id="vote_target_id" name="vote_target_id"
                        class="w-full p-2 border-2 border-gray-600 bg-gray-700 text-mun-light-text rounded-lg focus:border-indigo-500 focus:ring-indigo-500"
                        {% if current_vote_target %} disabled {% endif %}>
                        <option value="">-- Select a Resolution/Amendment --</option>
                        {% for doc in votable_docs %}
                            <option value="{{ doc.id }}"
                                data-title="{{ doc.title }}"
                                data-type="{{ doc.type }}">
                                ({{ doc.type.upper() }}) - {{ doc.title }}
                            </option>
                        {% endfor %}
                    </select>

                    <button onclick="startVote()" id="start-vote-btn"
                        class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-3 rounded-lg transition duration-150 transform active:scale-95 disabled:bg-gray-600 disabled:text-gray-400"
                        {% if current_vote_target %} disabled {% endif %}>
                        START FORMAL VOTE
                    </button>
                </div>

                <div id="vote-finalization-controls" class="mt-6 space-y-4 hidden">
                    <h3 class="text-lg font-bold text-indigo-400">Finalize Vote</h3>
                    <div id="vote-tally" class="p-4 bg-[#2a3749] rounded-lg">
                        <p class="font-bold text-md text-mun-light-text mb-2">Live Vote Status:</p>
                        <p class="text-mun-secondary-text">Votes Cast: <span id="voter-count" class="font-bold text-indigo-400">0</span> / <span id="total-delegates-count">{{ VALID_DELEGATES|length }}</span></p>
                    </div>
                    <button onclick="finalizeVote()" id="finalize-vote-btn"
                        class="w-full bg-mun-primary hover:bg-[#A82323] text-white font-semibold py-3 rounded-lg transition duration-150 transform active:scale-95">
                        FINALIZE VOTE & PUBLISH RESULT
                    </button>
                </div>
            </div>

        </section>

        <section class="w-2/3 bg-mun-card p-6 rounded-xl shadow-xl">
            <h2 class="text-2xl font-bold text-mun-light-text mb-4 border-b border-gray-600 pb-2">Live Document Stream (View Only)</h2>
            <div id="document-stream" class="h-[75vh] overflow-y-auto pr-2 text-mun-light-text">
                </div>
        </section>

    </main>

    <script>
        // ... (The original JavaScript is inserted here, unchanged)
        const socket = io({
            // Prioritize WebSocket transport
            transports: ['websocket', 'polling'],
            // Ensure the connection finds the correct endpoint path
            path: '/socket.io/'
        });
        const documentStream = document.getElementById('document-stream');
        const voteTargetSelect = document.getElementById('vote_target_id');
        const startVoteBtn = document.getElementById('start-vote-btn');
        const voteActiveStatus = document.getElementById('vote-active-status');
        const voteSelectionControls = document.getElementById('vote-selection-controls');
        const voteFinalizationControls = document.getElementById('vote-finalization-controls');
        // Removed yayCount and nayCount
        const voterCount = document.getElementById('voter-count');

        // Initial state based on Flask template context
        const initialVoteTarget = "{{ current_vote_target.title if current_vote_target else '' }}";
        if (initialVoteTarget) {
            showFinalizationControls(initialVoteTarget);
        } else {
            hideFinalizationControls();
        }

        // --- Polling Logic (NEW) ---

        function fetchStreamUpdate() {
            // Use Fetch API to get the new stream content from the dedicated API endpoint
            fetch('{{ url_for("stream_content_api") }}')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.text();
                })
                .then(html => {
                    // Update the stream's HTML content
                    documentStream.innerHTML = html;
                    documentStream.scrollTop = 0; // Keep newest items visible
                    // console.log('Admin Stream updated via AJAX polling.');
                })
                .catch(error => console.error('Error fetching admin stream:', error));
        }

        // Start polling immediately and then every 5 seconds (5000 milliseconds)
        fetchStreamUpdate();
        const pollingInterval = setInterval(fetchStreamUpdate, 5000);

        // Clear the interval when the page is unloaded to prevent memory leaks
        window.addEventListener('beforeunload', () => {
            clearInterval(pollingInterval);
        });

        // (END NEW Polling Logic)

        // --- SocketIO Handlers (MODIFIED) ---

        socket.on('connect', function() {
            console.log('Connected as Admin.');
        });

        // REMOVED: socket.on('stream_update', ...) - SocketIO no longer handles stream updates here

        socket.on('feedback', function(msg) {
            displayFlashMessage(msg.message, 'info');
        });

        // Live Vote Tally Update (Simplified to only use voter_count)
        socket.on('vote_tally_update', function(data) {
            // yayCount.textContent = data.yay; // Removed
            // nayCount.textContent = data.nay; // Removed
            voterCount.textContent = data.voter_count;

            // Ensure finalization controls are visible if a tally comes in
            if (voteFinalizationControls.classList.contains('hidden')) {
                showFinalizationControls(data.target_title);
            }
        });

        // Handles state refresh after vote finalization or stream clear
        socket.on('admin_state_update', function() {
            // Force a page reload to fetch the new votable_docs list and state
            window.location.reload();
        });

        // --- Action Functions ---

        function clearStream() {
            if (confirm('Are you SURE you want to clear the ENTIRE document stream and end any active vote? This cannot be undone.')) {
                socket.emit('moderator_action', { action: 'clear_stream' });
            }
        }

        function postAnnouncement() {
            const content = document.getElementById('announcement-content').value;
            if (content.trim()) {
                socket.emit('moderator_action', { action: 'announce', content: content });
                document.getElementById('announcement-content').value = ''; // Clear form
            } else {
                displayFlashMessage('Announcement cannot be empty.', 'error');
            }
        }

        function startVote() {
            const docId = voteTargetSelect.value;
            const docTitle = voteTargetSelect.options[voteTargetSelect.selectedIndex].getAttribute('data-title');

            if (!docId) {
                displayFlashMessage('Please select a document to vote on.', 'error');
                return;
            }

            if (confirm(`Start formal vote on: ${docTitle}?`)) {
                socket.emit('moderator_action', { action: 'start_vote', target_id: docId });
                // NEW: Reset and show controls
                showFinalizationControls(docTitle);
                resetTallyDisplay();
            }
        }

        function finalizeVote() {
            if (confirm('Are you SURE you want to finalize the vote and publish the result? Voting will be closed for all delegates.')) {
                socket.emit('moderator_action', { action: 'finalize_vote' });
                hideFinalizationControls();
                resetTallyDisplay();
            }
        }

        // --- UI Control Functions ---

        function resetTallyDisplay() {
            // Only reset the voter count
            voterCount.textContent = '0';
        }

        function showFinalizationControls(title) {
            voteActiveStatus.className = 'p-4 bg-yellow-800/50 border-l-4 border-yellow-500 mb-4';
            voteActiveStatus.innerHTML = `<p class="font-bold text-yellow-300">VOTE IN PROGRESS:</p><p class="text-sm text-yellow-200">${title}</p>`;

            voteFinalizationControls.classList.remove('hidden');
            startVoteBtn.disabled = true;
            voteTargetSelect.disabled = true;
        }

        function hideFinalizationControls() {
            voteActiveStatus.className = 'p-4 bg-green-800/50 border-l-4 border-green-500 mb-4';
            voteActiveStatus.innerHTML = `<p class="font-bold text-green-300">NO VOTE ACTIVE</p>`;

            voteFinalizationControls.classList.add('hidden');
            startVoteBtn.disabled = false;
            voteTargetSelect.disabled = false;
            voteTargetSelect.value = ""; // Clear selection
        }


        function displayFlashMessage(message, category) {
            const container = document.getElementById('flash-container');
            const element = document.createElement('li');
            element.className = `p-3 rounded-lg font-medium border-l-4 my-2 transition duration-500 opacity-0`;

            if (category === 'error') {
                element.classList.add('bg-red-800', 'text-white', 'border-red-500');
            } else if (category === 'info') {
                 element.classList.add('bg-blue-800', 'text-white', 'border-blue-500');
            } else {
                 element.classList.add('bg-green-800', 'text-white', 'border-green-500');
            }

            element.textContent = message;
            container.prepend(element);

            // Animate in and out
            setTimeout(() => element.classList.remove('opacity-0'), 10);
            setTimeout(() => element.classList.add('opacity-0'), 5000);
            setTimeout(() => element.remove(), 5600);
        }
    </script>
</body>
</html>