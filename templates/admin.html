admin.html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal (Chairman)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #F5F5F7; }
        .sidebar { background-color: #0B2447; }
        .header { border-bottom: 2px solid #D1D5DB; }
        textarea { resize: none; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="header bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-10">
        <h1 class="text-2xl font-bold text-[#D32F2F]">Admin Portal ({{ delegate_id }})</h1>
        <div class="flex items-center space-x-4">
            <a href="{{ url_for('dashboard') }}" target="_blank" class="text-sm font-medium text-gray-600 hover:text-red-600 transition">View Dashboard</a>
            <a href="{{ url_for('logout') }}" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Logout</a>
        </div>
    </header>

    <main class="flex flex-grow p-6 space-x-6">

        <section class="w-1/3 space-y-6">

            <div id="flash-container">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        <ul class="space-y-2">
                            {% for category, message in messages %}
                                <li class="p-3 rounded-lg font-medium border-l-4
                                    {% if category == 'error' %} bg-red-100 text-red-800 border-red-600
                                    {% elif category == 'info' %} bg-blue-100 text-blue-800 border-blue-600
                                    {% else %} bg-green-100 text-green-800 border-green-600
                                    {% endif %}" id="flash-{{ loop.index }}">
                                    {{ message }}
                                </li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                {% endwith %}
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-[#D32F2F] space-y-4">
                <h2 class="text-xl font-bold text-[#D32F2F]">Chairman Actions</h2>
                <button onclick="clearStream()"
                    class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 rounded-lg transition duration-150">
                    Clear Document Stream
                </button>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-[#D32F2F]">
                <h2 class="text-xl font-bold text-[#D32F2F] mb-4">Post Announcement</h2>
                <textarea id="announcement-content" rows="3"
                    class="w-full p-2 border-2 border-gray-300 rounded-lg focus:border-[#D32F2F] focus:ring-[#D32F2F]"
                    placeholder="Type official announcement here..."></textarea>
                <button onclick="postAnnouncement()"
                    class="mt-3 w-full bg-[#D32F2F] hover:bg-[#B71C1C] text-white font-semibold py-3 rounded-lg transition duration-150">
                    Post to Stream
                </button>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-indigo-600">
                <h2 class="text-xl font-bold text-indigo-800 mb-4">Formal Vote Control</h2>

                {% if current_vote_target %}
                    <div id="vote-active-status" class="p-4 bg-yellow-100 border-l-4 border-yellow-500 mb-4">
                        <p class="font-bold text-yellow-800">VOTE IN PROGRESS:</p>
                        <p class="text-sm text-yellow-700">{{ current_vote_target.title }}</p>
                    </div>
                {% else %}
                    <div id="vote-active-status" class="p-4 bg-green-100 border-l-4 border-green-500 mb-4">
                        <p class="font-bold text-green-800">NO VOTE ACTIVE</p>
                    </div>
                {% endif %}

                <div id="vote-selection-controls" class="space-y-4">
                    <label for="vote_target_id" class="block text-sm font-medium text-gray-700 mb-2">Select Document to Vote On:</label>
                    <select id="vote_target_id" name="vote_target_id"
                        class="w-full p-2 border-2 border-gray-300 rounded-lg focus:border-indigo-600 focus:ring-indigo-600"
                        {% if current_vote_target %} disabled {% endif %}>
                        <option value="">-- Select a Resolution/Amendment --</option>
                        {% for doc in votable_docs %}
                            <option value="{{ doc.id }}"
                                data-title="{{ doc.title }}"
                                data-type="{{ doc.type }}">
                                ({{ doc.type.upper() }}) - {{ doc.title }}
                            </option>
                        {% endfor %}
                    </select>

                    <button onclick="startVote()" id="start-vote-btn"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg transition duration-150 transform active:scale-95 disabled:bg-gray-400"
                        {% if current_vote_target %} disabled {% endif %}>
                        START FORMAL VOTE
                    </button>
                </div>

                <div id="vote-finalization-controls" class="mt-6 space-y-4 hidden">
                    <h3 class="text-lg font-bold text-indigo-800">Finalize Vote</h3>
                    <div id="vote-tally" class="p-4 bg-indigo-50 rounded-lg">
                        <p class="font-bold text-md text-indigo-800 mb-2">Live Tally:</p>
                        <p>Yay: <span id="yay-count" class="font-bold text-green-600">0</span></p>
                        <p>Nay: <span id="nay-count" class="font-bold text-red-600">0</span></p>
                        <p>Voted: <span id="voter-count" class="font-bold text-indigo-600">0</span> / <span id="total-delegates-count">{{ VALID_DELEGATES|length }}</span></p>
                    </div>

                    <button onclick="finalizeVote()" id="finalize-vote-btn"
                        class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 rounded-lg transition duration-150 transform active:scale-95">
                        FINALIZE VOTE & PUBLISH RESULT
                    </button>
                </div>
            </div>

        </section>

        <section class="w-2/3 bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-[#0B2447] mb-4 border-b pb-2">Live Document Stream (View Only)</h2>
            <div id="document-stream" class="h-[75vh] overflow-y-auto pr-2">
                </div>
        </section>

    </main>

    <script>
        const socket = io();
        const documentStream = document.getElementById('document-stream');
        const voteTargetSelect = document.getElementById('vote_target_id');
        const startVoteBtn = document.getElementById('start-vote-btn');
        const voteActiveStatus = document.getElementById('vote-active-status');
        const voteSelectionControls = document.getElementById('vote-selection-controls');
        const voteFinalizationControls = document.getElementById('vote-finalization-controls');
        const yayCount = document.getElementById('yay-count');
        const nayCount = document.getElementById('nay-count');
        const voterCount = document.getElementById('voter-count');

        // Initial state based on Flask template context
        const initialVoteTarget = "{{ current_vote_target.title if current_vote_target else '' }}";
        if (initialVoteTarget) {
            showFinalizationControls(initialVoteTarget);
        } else {
            hideFinalizationControls();
        }


        // --- SocketIO Handlers ---

        socket.on('connect', function() {
            console.log('Connected as Admin.');
        });

        socket.on('stream_update', function(msg) {
            documentStream.innerHTML = msg.data;
            documentStream.scrollTop = 0;
        });

        socket.on('feedback', function(msg) {
            displayFlashMessage(msg.message, 'info');
        });

        // NEW: Live Vote Tally Update
        socket.on('vote_tally_update', function(data) {
            yayCount.textContent = data.yay;
            nayCount.textContent = data.nay;
            voterCount.textContent = data.voter_count;

            // Ensure finalization controls are visible if a tally comes in
            if (voteFinalizationControls.classList.contains('hidden')) {
                showFinalizationControls(data.target_title);
            }
        });

        // NEW: Handles state refresh after vote finalization or stream clear
        socket.on('admin_state_update', function() {
            // Force a page reload to fetch the new votable_docs list and state
            window.location.reload();
        });

        // --- Action Functions ---

        function clearStream() {
            if (confirm('Are you SURE you want to clear the ENTIRE document stream and end any active vote? This cannot be undone.')) {
                socket.emit('moderator_action', { action: 'clear_stream' });
            }
        }

        function postAnnouncement() {
            const content = document.getElementById('announcement-content').value;
            if (content.trim()) {
                socket.emit('moderator_action', { action: 'announce', content: content });
                document.getElementById('announcement-content').value = ''; // Clear form
            } else {
                displayFlashMessage('Announcement cannot be empty.', 'error');
            }
        }

        function startVote() {
            const docId = voteTargetSelect.value;
            const docTitle = voteTargetSelect.options[voteTargetSelect.selectedIndex].getAttribute('data-title');

            if (!docId) {
                displayFlashMessage('Please select a document to vote on.', 'error');
                return;
            }

            if (confirm(`Start formal vote on: ${docTitle}?`)) {
                socket.emit('moderator_action', { action: 'start_vote', target_id: docId });
                showFinalizationControls(docTitle);
            }
        }

        function finalizeVote() {
            if (confirm('Are you SURE you want to finalize the vote and publish the result? Voting will be closed for all delegates.')) {
                socket.emit('moderator_action', { action: 'finalize_vote' });
                hideFinalizationControls();

                // Reset live tally display
                yayCount.textContent = '0';
                nayCount.textContent = '0';
                voterCount.textContent = '0';
            }
        }

        // --- UI Control Functions ---

        function showFinalizationControls(title) {
            voteActiveStatus.className = 'p-4 bg-yellow-100 border-l-4 border-yellow-500 mb-4';
            voteActiveStatus.innerHTML = `<p class="font-bold text-yellow-800">VOTE IN PROGRESS:</p><p class="text-sm text-yellow-700">${title}</p>`;

            voteFinalizationControls.classList.remove('hidden');
            startVoteBtn.disabled = true;
            voteTargetSelect.disabled = true;
        }

        function hideFinalizationControls() {
            voteActiveStatus.className = 'p-4 bg-green-100 border-l-4 border-green-500 mb-4';
            voteActiveStatus.innerHTML = `<p class="font-bold text-green-800">NO VOTE ACTIVE</p>`;

            voteFinalizationControls.classList.add('hidden');
            startVoteBtn.disabled = false;
            voteTargetSelect.disabled = false;
            voteTargetSelect.value = ""; // Clear selection
        }


        function displayFlashMessage(message, category) {
            const container = document.getElementById('flash-container');
            const element = document.createElement('li');
            element.className = `p-3 rounded-lg font-medium border-l-4 my-2 transition duration-500 opacity-0`;

            if (category === 'error') {
                element.classList.add('bg-red-100', 'text-red-800', 'border-red-600');
            } else {
                element.classList.add('bg-blue-100', 'text-blue-800', 'border-blue-600');
            }

            element.textContent = message;
            container.prepend(element);

            // Animate in and out
            setTimeout(() => element.classList.remove('opacity-0'), 10);
            setTimeout(() => element.classList.add('opacity-0'), 5000);
            setTimeout(() => element.remove(), 5600);
        }
    </script>
</body>
</html>